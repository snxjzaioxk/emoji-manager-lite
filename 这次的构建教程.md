# Emoji Manager Lite 本次构建与变更说明

本文档记录了本次对项目进行的修复、功能增强、打包配置与使用方法，帮助你在本地预览与产出 Windows EXE 安装包/便携版。

## 概览

本次工作涵盖：

- 修复开发/生产环境判断与开发脚本，保证 Electron 开发调试顺畅。
- 完善导入流程，支持多来源（文件夹/多文件）。
- 增强筛选：收藏夹与最近使用逻辑正确映射；最近使用可配置数量上限。
- 新增格式转换（JPG/PNG/WebP），支持单个与批量转换并自动导入新文件。
- 新增批量导出所选表情到指定文件夹。
- 新增分类管理（新建/重命名/删除），删除分类会将表情迁移到默认分类。
- 文件存储位置（storageLocation）设置生效；图片尺寸读取更准确（sharp + nativeImage 兜底）。
- 样式/交互若干修复，补齐缺失样式工具类。
- 打包流程脚本化：一键生成图标（支持占位），自动检查图标，产出 NSIS 安装包与便携版。

## 环境准备

- Node.js 18+
- Windows 打包所需（如需产出 .exe）：
  - Python 3.x（加入 PATH）
  - Visual Studio Build Tools（勾选“使用 C++ 的桌面开发”和 Windows 10/11 SDK）

> 说明：本次为适配受限网络，将原生依赖重建关闭（`npmRebuild: false`），可在联网环境重新开启以获得最优兼容性。

## 本次主要改动

### 1) 开发/构建脚本与打包配置

- 开发模式判断切换为 `!app.isPackaged`（src/main/main.ts）。
- 新增开发引导脚本 `scripts/dev-electron.js`，等待 Vite 与主进程编译后启动 Electron。
- package.json 脚本调整：

```jsonc
{
  "scripts": {
    "dev": "concurrently \"npm run dev:renderer\" \"npm run dev:main\" \"npm run dev:electron\"",
    "dev:renderer": "vite",
    "dev:main": "tsc --project tsconfig.main.json --watch",
    "dev:electron": "node scripts/dev-electron.js",

    "icons": "node scripts/generate-icons.js assets/icon.png",
    "icons:from": "node scripts/generate-icons.js",
    "ensure:icons": "node scripts/check-icons.js",

    "predist": "npm run ensure:icons",
    "dist": "npm run build && electron-builder",
    "predist:win": "npm run ensure:icons",
    "dist:win": "electron-builder --win nsis --publish never",
    "predist:portable": "npm run ensure:icons",
    "dist:portable": "electron-builder --win portable --publish never"
  }
}
```

- 打包配置（package.json -> build）：
  - `files` 包含 `assets/**/*`；
  - Windows：NSIS 安装包、可执行名格式化、关闭签名编辑（离线环境避免下载签名工具）；
  - 关闭原生依赖重建：`npmRebuild: false`（网络受限模式）；
  - 图标：指向 `assets/icon.ico`（若缺失则使用 Electron 默认图标）。

### 2) 图标工具与自动化

- 脚本 `scripts/generate-icons.js`：
  - 从 1024x1024 PNG 生成多尺寸 PNG、ICO（`png-to-ico`）、ICNS（`icon-gen`）。
  - 命令：
    - `npm run icons`（默认从 `assets/icon.png` 生成）
    - `npm run icons:from -- <你的png路径>`
- 脚本 `scripts/check-icons.js`：
  - 打包前自动检查 `icon.ico`/`icon.icns`/`assets/icons` 是否存在；
  - 若缺失且无 `assets/icon.png`，自动生成一个占位 `icon.png`，以不中断打包；
  - 被 `predist*` 钩子自动调用。

> 受限网络下，`png-to-ico`/`icon-gen` 未安装时会跳过 ICO/ICNS 生成，打包将使用 Electron 默认图标。放置品牌图到 `assets/icon.png` 并执行 `npm install` 后重试可生效。

### 3) 主进程与数据库

- main.ts：
  - 开发模式判断改为 `!app.isPackaged`；
  - 新增 IPC：`update-category`、`delete-category`。
- database.ts：
  - `getEmojis(filters: SearchFilters)` 支持排序/限制（`sortBy/sortOrder/limit`）。
  - 默认设置新增 `recentLimit`。
  - 新增 `updateCategory(id, updates)` 与 `deleteCategory(id)`（删除会将该分类下表情迁移到 `default` 分类）。

### 4) 文件管理（主进程）

- fileManager.ts：
  - 支持从设置读取 `storageLocation`，并在导入/导出/删除前确保目录存在；
  - 导入支持多来源：
    - `ImportOptions.sourcePaths?: string[]` 或 `sourcePath` 中 `;` 分隔多个路径；
  - 图片尺寸读取：优先 `sharp(...).metadata()`，降级 `nativeImage.getSize()`；
  - 格式转换：支持 `jpg/jpeg/png/webp`，产物写入系统临时目录，随后自动由渲染层导入；
  - `getFileInfo` 返回准确的宽高。

### 5) 预加载与全局类型

- preload.ts：`categories.update`、`categories.delete` 暴露到渲染层。
- global.d.ts：
  - `openLocation` 类型改为 `Promise<boolean>`；
  - `categories.update / delete` 类型声明。
  
### 6) 渲染层 UI/交互

- App.tsx：
  - 收藏夹筛选改为 `isFavorite=true`；
  - 最近使用：按 `updatedAt DESC`，数量取 `settings.recentLimit`（默认 100）。
- Sidebar.tsx：
  - 自定义分类：支持“新建/重命名/删除”，菜单在每项右侧 `…`；
  - 删除分类会提示并迁移表情到默认分类；
  - 通过 `onCategoriesChange` 通知父组件刷新数据。
- EmojiGrid.tsx：
  - 批量转换：JPG/PNG/WebP；
  - 批量导出选中到文件夹；
  - 批量删除/取消选择。
- EmojiCard.tsx / EmojiListItem.tsx：
  - 单项菜单提供“复制/收藏/打开位置/删除/转换格式为（JPG/PNG/WebP）”。
- Toolbar.tsx：修复类名 `text-text-muted` → `text-muted`。

### 7) 样式与工具类

- index.css：
  - 补齐 `.bg-primary/.bg-secondary/.bg-bg-secondary/.bg-bg-tertiary/.border-border-color`；
  - 新增 `.hover:bg-secondary`；
  - 分隔线类 `my-1` 替换为 `mt-1 mb-1`。

### 8) 共享类型

- src/shared/types.ts：
  - `ImportOptions` 新增 `sourcePaths?: string[]`；
  - `SearchFilters` 新增 `sortBy/sortOrder/limit`；
  - `AppSettings` 新增 `recentLimit`。

## 使用说明（本地预览）

完整功能（Electron 下预览，含数据库/文件能力）：

```bash
npm install
npm run dev
```

仅前端界面（无主进程能力，快速浏览 UI）：

```bash
npm run test:renderer
# 浏览器访问 http://localhost:3000
```

## 打包为 Windows EXE

建议先准备图标：

```bash
# 将 1024x1024 PNG 放到 assets/icon.png
npm run icons           # 或者： npm run icons:from -- <你的png路径>
```

打包（离线/受限网络友好模式）：

```bash
# 一步构建并打包 Windows 安装包（NSIS）
npm run dist:win

# 或完整构建+打包（跨平台）
npm run dist

# 便携版（portable），免安装
npm run dist:portable
```

产物位置：

- 安装包：`release/Emoji-Manager-Lite-Setup-<版本>.exe`
- 便携运行：`release/win-unpacked/Emoji Manager Lite.exe`

> 说明：本次为了适配网络限制：
> - 关闭了原生依赖重建（`npmRebuild: false`）；
> - 关闭签名编辑（`signAndEditExecutable: false`）。
> 如需更好的兼容性与品牌图标，请在联网环境下执行 `npm install`（安装 `png-to-ico`/`icon-gen` 等）后重新打包。

## 新增/增强功能速览

- 导入：文件夹/多文件，去重（文件名+大小）、自动标签、目标分类选择。
- 收藏夹/最近使用：
  - 收藏夹 → `isFavorite=true`；
  - 最近使用 → `updatedAt DESC`，数量可配置（默认 100）。
- 分类管理：新建/重命名/删除（删除迁移到默认分类）。
- 格式转换：JPG/PNG/WebP（单个/批量），转换后自动导入为新表情。
- 批量操作：转换、导出、删除、取消选择。
- 设置：主题/视图/缩略图大小；路径设置；最近使用显示数量；最大存储大小；自动备份（预留）。

## 交互修复/优化（选摘）

- 修复搜索图标颜色类名；补齐多个样式工具类；
- 调整菜单分隔线的外边距，避免布局异常；
- 改善开发模式判断，保证 dev 下加载 Vite URL；
- 批量操作条在选择后展示，操作后清空选择。

## 常见问题与说明

- EXE 没有品牌图标：
  - 受限网络下 `png-to-ico`/`icon-gen` 未安装会跳过 ICO/ICNS 生成，Electron 将使用默认图标；
  - 解决：放置 `assets/icon.png` 并在联网环境 `npm install` 后重新执行 `npm run dist:win`。
- sqlite3 原生依赖：
  - 本次关闭重建，如目标机器报加载失败，需在具备编译环境与网络的机器上重新打包或改用 better-sqlite3。
- 签名：
  - 未配置代码签名，Windows SmartScreen 可能提示未知发布者；本地使用不影响，对外分发需证书配置。

## 文件变更列表

- package.json（脚本与打包配置）
- scripts/dev-electron.js（开发启动器）
- scripts/generate-icons.js（图标生成）
- scripts/check-icons.js（打包前图标检查与占位生成）
- src/main/main.ts（开发判断/IPC）
- src/main/preload.ts（categories.update/delete 暴露）
- src/main/fileManager.ts（存储位置、导入多源、尺寸/转换、导出/删除健壮性）
- src/main/database.ts（排序/限制、分类增改删、默认设置 recentLimit）
- src/shared/types.ts（ImportOptions、SearchFilters、AppSettings 扩展）
- src/renderer/src/App.tsx（筛选逻辑、最近使用上限、刷新钩子）
- src/renderer/src/components/Sidebar.tsx（分类管理 UI）
- src/renderer/src/components/EmojiGrid.tsx（批量转换/导出）
- src/renderer/src/components/EmojiCard.tsx（转换格式子菜单）
- src/renderer/src/components/EmojiListItem.tsx（转换格式子菜单）
- src/renderer/src/components/Toolbar.tsx（类名修复）
- src/renderer/src/index.css（样式工具类）
- src/renderer/src/global.d.ts（类型更新）
- assets/README.md（图标说明）

---

如需我继续：

- “点击菜单外关闭”弹出菜单；
- 删除分类时支持“合并到指定分类”；
- 存储位置迁移工具（将既有文件移动到新位置并更新数据库）。

